<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hi-C Voronoi Binning Explorer</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app-container">
        <aside id="sidebar">
            <div class="logo">
                <h1>Hi-C Explorer</h1>
            </div>
            <nav>
                <button class="nav-btn active" data-panel="panel-input">Input Data</button>
                <button class="nav-btn" data-panel="panel-processing">Processing</button>
                <button class="nav-btn" data-panel="panel-visualization">Visualization</button>
                <button class="nav-btn" data-panel="panel-voroserp">Voroserp Binning</button>
            </nav>
            <button id="processVisualizeButton" class="action-button">Process & Visualize</button>
            <div id="statusMessages" class="status-bar">Ready.</div>
        </aside>

        <main id="main-content">
            <div class="panel active-panel" id="panel-input">
                <h2><span class="icon">üìÑ</span>Input Data</h2>
                <div class="form-group">
                    <label for="matrixAFile">Matrix A (CSV):</label>
                    <input type="file" id="matrixAFile" accept=".csv">
                </div>
                <div class="form-group">
                    <label for="matrixBFile">Matrix B (CSV): (Optional for single matrix view)</label>
                    <input type="file" id="matrixBFile" accept=".csv">
                </div>
                <div class="form-group">
                    <label for="format">Input Format:</label>
                    <select id="format">
                        <option value="sparse_individual">Sparse Individual (row, col, val)</option>
                        <option value="sparse_list_ab">Sparse List (row, col, valA, valB)</option>
                        <option value="dense">Dense Matrix (experimental)</option>
                    </select>
                    <small>For "Sparse Individual", upload Matrix A and optionally B. For "Sparse List AB", only Matrix A input is used.</small>
                </div>
                <div class="form-group">
                    <label for="matrixDim">Matrix Dimension (N):</label>
                    <input type="number" id="matrixDim" value="200" min="10">
                    <small>Max row/col index + 1. Auto-detected for sparse if possible, otherwise used for canvas scaling if files are not yet loaded.</small>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="isTriangular">
                    <label for="isTriangular">Input is Upper/Lower Triangular</label>
                    <small>Check if your sparse input only contains one half of a symmetric matrix. Data will be symmetrized.</small>
                </div>
            </div>

            <div class="panel" id="panel-processing">
                <h2><span class="icon">‚öôÔ∏è</span>Initial Processing Options</h2>
                <div class="form-group">
                    <label for="logBase">Log Base for Ratio (if two matrices):</label>
                    <select id="logBase">
                        <option value="2">Log2</option>
                        <option value="10">Log10</option>
                        <option value="e">LogE (Natural)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pseudocount">Pseudocount (for Log Ratio & single matrix view):</label>
                    <input type="number" id="pseudocount" value="1" min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label for="valueThreshold">Min Point Value Sum (A+B or A if single) Threshold:</label>
                    <input type="number" id="valueThreshold" value="1" min="0">
                    <small>Initial points below this are excluded before any binning.</small>
                </div>
                <div class="form-group">
                    <label for="maxPoints">Max Points for Initial Delaunay/Voronoi:</label>
                    <input type="number" id="maxPoints" value="10000" min="100" step="100">
                    <small>Performance limit. Highest sum points prioritized.</small>
                </div>
            </div>

            <div class="panel" id="panel-visualization">
                <h2><span class="icon">üé®</span>Visualization Options</h2>
                 <div class="form-group">
                    <h3>Maps to Display:</h3>
                    <div class="checkbox-group multi-check">
                        <input type="checkbox" id="displayInputA" checked><label for="displayInputA">Input A (Raw)</label>
                        <input type="checkbox" id="displayInputB" checked><label for="displayInputB">Input B (Raw)</label>
                        <input type="checkbox" id="displayNaiveLogRatio" checked><label for="displayNaiveLogRatio">Naive Log Ratio</label>
                        <input type="checkbox" id="displayBinnedA" checked><label for="displayBinnedA">Voroserp A</label>
                        <input type="checkbox" id="displayBinnedB" checked><label for="displayBinnedB">Voroserp B</label>
                        <input type="checkbox" id="displayBinnedLogRatio" checked><label for="displayBinnedLogRatio">Voroserp Log Ratio</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="colormapLogRatio">Colormap (Log Ratio):</label>
                    <select id="colormapLogRatio">
                        <option value="seismic">Seismic (Blue-White-Red)</option>
                        <option value="custom_pastelpentine">PastelPentine</option>
                        <option value="viridis">Viridis (Sequential)</option>
                        <option value="plasma">Plasma (Sequential)</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="colormapSingle">Colormap (Single Matrix A/B):</label>
                    <select id="colormapSingle">
                        <option value="reds">Reds</option>
                        <option value="blues">Blues</option>
                        <option value="purples">Purples</option>
                        <option value="viridis_single">Viridis</option>
                        <option value="plasma_single">Plasma</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="colorMinLogRatio">Log Ratio Color Scale Min:</label>
                    <input type="number" id="colorMinLogRatio" value="-2" step="0.1">
                </div>
                <div class="form-group">
                    <label for="colorMaxLogRatio">Log Ratio Color Scale Max:</label>
                    <input type="number" id="colorMaxLogRatio" value="2" step="0.1">
                </div>
                 <div class="form-group checkbox-group">
                    <input type="checkbox" id="autoScaleSingleMatrix" checked>
                    <label for="autoScaleSingleMatrix">Auto-scale Single Matrix Colors</label>
                 </div>
                 <div class="form-group">
                    <label for="colorMinSingle">Single Matrix Min (if not auto):</label>
                    <input type="number" id="colorMinSingle" value="0" step="1">
                </div>
                <div class="form-group">
                    <label for="colorMaxSingle">Single Matrix Max (if not auto):</label>
                    <input type="number" id="colorMaxSingle" value="100" step="1">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="showDelaunay" checked>
                    <label for="showDelaunay">Show Delaunay Triangulation Overlay</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="showVoronoiEdges">
                    <label for="showVoronoiEdges">Show Voronoi Cell Edges Overlay</label>
                </div>
                 <div class="form-group checkbox-group">
                    <input type="checkbox" id="showPoints">
                    <label for="showPoints">Show Points Overlay</label>
                </div>
                <div class="form-group">
                    <label for="pointSize">Point Overlay Size:</label>
                    <input type="number" id="pointSize" value="1.0" min="0.1" step="0.1">
                </div>
                <div class="form-group">
                    <label for="canvasSize">Canvas Size (px per map):</label>
                    <input type="number" id="canvasSize" value="400" min="200" step="50">
                </div>
            </div>
            
            <div class="panel" id="panel-voroserp">
                <h2><span class="icon">üî¨</span>Voroserp Iterative Binning</h2>
                 <div class="form-group checkbox-group">
                    <input type="checkbox" id="enableVoroserp">
                    <label for="enableVoroserp">Enable Voroserp Binning</label>
                    <small>This performs iterative merging. Can be computationally intensive. Display options for "Voroserp A/B/LogRatio" depend on this.</small>
                </div>
                <div class="form-group">
                    <label for="voroserpThresholdA">Voroserp Merge Threshold (Matrix A):</label>
                    <input type="number" id="voroserpThresholdA" value="20" min="1">
                    <small>Points with valA below this are candidates for merging (if Voroserp A enabled).</small>
                </div>
                <div class="form-group">
                    <label for="voroserpThresholdB">Voroserp Merge Threshold (Matrix B):</label>
                    <input type="number" id="voroserpThresholdB" value="20" min="1">
                    <small>Points with valB below this are candidates for merging (if Voroserp B enabled and Matrix B loaded).</small>
                </div>
                <div class="form-group">
                    <label for="voroserpMaxIter">Voroserp Max Iterations:</label>
                    <input type="number" id="voroserpMaxIter" value="1000" min="10" step="100">
                </div>
                 <div class="form-group checkbox-group">
                    <label for="runInWorker">Run Voroserp in Web Worker:</label>
                    <input type="checkbox" id="runInWorker" checked>
                    <small>Recommended for smoother UI during intensive processing.</small>
                </div>
                <div id="voroserpProgressA" class="progress-bar-container" style="display:none;">
                    <div class="progress-bar-label">Voroserp A: <span id="voroserpIterCountA">0</span> iter (<span id="voroserpMergedCountA">0</span> merged)</div>
                    <div class="progress-bar"><div id="voroserpProgressBarFillA" style="width: 0%;"></div></div>
                </div>
                 <div id="voroserpProgressB" class="progress-bar-container" style="display:none;">
                    <div class="progress-bar-label">Voroserp B: <span id="voroserpIterCountB">0</span> iter (<span id="voroserpMergedCountB">0</span> merged)</div>
                    <div class="progress-bar"><div id="voroserpProgressBarFillB" style="width: 0%;"></div></div>
                </div>
            </div>

            <div id="visualization-output-area">
                <!-- Canvases will be dynamically added here -->
            </div>
        </main>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="utils.js"></script>
    <script src="parser.js"></script>
    <script src="dataProcessor.js"></script>
    <script src="voroserp.js"></script> 
    <script src="visualizer.js"></script>
    <script src="main.js"></script>
</body>
</html>